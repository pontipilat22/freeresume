<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Studio</title>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; }
        
        /* –¢–∞–±—ã */
        .tabs { display: flex; background: #000; position: sticky; top:0; z-index: 100; border-bottom: 1px solid #222; }
        .tab { flex: 1; padding: 16px; text-align: center; color: #666; font-weight: 600; text-transform: uppercase; font-size: 13px; cursor: pointer; }
        .tab.active { color: #fff; border-bottom: 3px solid #fff; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; display: none; }
        .container.active { display: flex; flex-direction: column; gap: 20px; animation: fadeIn 0.4s; }

        h2 { font-weight: 300; text-align: center; margin: 10px 0 20px 0; }
        p.hint { color: #888; text-align: center; font-size: 14px; margin-top: -10px; line-height: 1.4; }

        /* –í–≤–æ–¥ –∏ –ö–Ω–æ–ø–∫–∏ */
        input, textarea {
            width: 100%; background: #1c1c1c; border: 1px solid #333; color: #fff;
            padding: 15px; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none;
        }
        input:focus, textarea:focus { border-color: #666; }

        /* –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ" - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
        .upload-area {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #151515; border: 2px dashed #444; border-radius: 16px;
            padding: 40px 20px; cursor: pointer; transition: 0.2s;
            margin-bottom: 10px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É */
        }
        .upload-area.active { border-color: #fff; background: #222; }
        .upload-icon { font-size: 30px; margin-bottom: 10px; }
        
        button.main-btn {
            width: 100%; padding: 18px; background: #fff; color: #000;
            border: none; border-radius: 14px; font-weight: 700; font-size: 16px;
            cursor: pointer; margin-top: 10px; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            box-shadow: 0 4px 15px rgba(255,255,255,0.1);
        }
        button.main-btn:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ (Aspect Ratio) */
        .format-selector { display: flex; gap: 10px; justify-content: space-between; margin-bottom: 10px; }
        .format-btn {
            flex: 1; background: #1c1c1c; border: 1px solid #333; border-radius: 10px;
            padding: 12px; color: #888; cursor: pointer; font-size: 13px; text-align: center;
        }
        .format-btn.active { background: #333; color: #fff; border-color: #fff; }
        .icon-rect { display: block; margin: 0 auto 5px auto; border: 2px solid currentColor; }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        .result-img { width: 100%; border-radius: 12px; margin-top: 20px; box-shadow: 0 5px 30px rgba(0,0,0,0.5); }
        .status-msg { text-align: center; color: #888; margin-top: 15px; font-size: 14px; }
        
        /* –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ ID (—á—Ç–æ–±—ã –Ω–µ –ø—É–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞) */
        .id-group { background: #111; padding: 15px; border-radius: 10px; border: 1px solid #222; margin-bottom: 20px; }
        .id-group label { font-size: 12px; color: #666; display: block; margin-bottom: 5px; }
        .id-group input { background: transparent; border: none; padding: 0; color: #4f4; font-family: monospace; font-size: 14px; }

        @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('train')">1. –°–æ–∑–¥–∞—Ç—å</div>
        <div class="tab" onclick="switchTab('gen')">2. –†–∏—Å–æ–≤–∞—Ç—å</div>
    </div>

    <!-- –≠–ö–†–ê–ù 1: –û–ë–£–ß–ï–ù–ò–ï -->
    <div id="train" class="container active">
        <h2>–ù–æ–≤—ã–π –ê–≤–∞—Ç–∞—Ä</h2>
        <p class="hint">–ó–∞–≥—Ä—É–∑–∏—Ç–µ 5-15 —Ñ–æ—Ç–æ –ª–∏—Ü–∞.<br>–û–±—É—á–µ–Ω–∏–µ –∑–∞–π–º–µ—Ç 30 –º–∏–Ω—É—Ç.</p>

        <input type="text" id="modelName" placeholder="–ò–º—è (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –Ω–∞–ø—Ä. Alex)">
        
        <label class="upload-area" id="dropArea">
            <div class="upload-icon">üì∏</div>
            <span id="fileLabel">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ</span>
            <input type="file" id="photos" multiple accept="image/*" style="display:none">
        </label>

        <button class="main-btn" onclick="startTraining()" id="trainBtn">–ó–ê–ü–£–°–¢–ò–¢–¨ –û–ë–£–ß–ï–ù–ò–ï ($1.5)</button>
        <div id="trainStatus" class="status-msg"></div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø -->
    <div id="gen" class="container">
        <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –§–æ—Ç–æ</h2>
        
        <!-- –ë–ª–æ–∫ —Å ID (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∞–º) -->
        <div class="id-group" id="idBlock" style="display:none;">
            <label>ID –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω):</label>
            <input type="text" id="tuneIdInput" readonly placeholder="–°–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å">
        </div>

        <p class="hint" id="noIdWarning" style="color: #f55; display:none;">
            –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –º–æ–¥–µ–ª—å –≤–æ –≤–∫–ª–∞–¥–∫–µ "–°–æ–∑–¥–∞—Ç—å"!
        </p>

        <!-- –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ -->
        <label style="color:#666; font-size:13px; margin-bottom:5px; display:block;">–§–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏:</label>
        <div class="format-selector">
            <div class="format-btn active" onclick="setSize(1024, 1024, this)">
                <span class="icon-rect" style="width:14px; height:14px;"></span>–ö–≤–∞–¥—Ä–∞—Ç
            </div>
            <div class="format-btn" onclick="setSize(768, 1024, this)">
                <span class="icon-rect" style="width:10px; height:16px;"></span>–ü–æ—Ä—Ç—Ä–µ—Ç
            </div>
            <div class="format-btn" onclick="setSize(1024, 768, this)">
                <span class="icon-rect" style="width:16px; height:10px;"></span>–ê–ª—å–±–æ–º
            </div>
        </div>

        <textarea id="promptInput" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ —Ñ–æ—Ç–æ (–Ω–∞ –∞–Ω–≥–ª). –ù–∞–ø—Ä–∏–º–µ—Ä: ohwx man in cyberpunk city, neon lights"></textarea>
        
        <button class="main-btn" onclick="generate()" id="genBtn">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>
        <div id="genStatus" class="status-msg"></div>
        <div id="gallery"></div>
    </div>

    <script>
        // –¢–µ–∫—É—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–≤–∞–¥—Ä–∞—Ç)
        let currentW = 1024;
        let currentH = 1024;

        // –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID
        window.onload = function() {
            const savedId = localStorage.getItem('my_astria_id');
            if(savedId) {
                document.getElementById('tuneIdInput').value = savedId;
                document.getElementById('idBlock').style.display = 'block';
            } else {
                document.getElementById('noIdWarning').style.display = 'block';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            
            if(tab === 'train') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('train').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('gen').classList.add('active');
                // –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä–∏–º ID
                const savedId = localStorage.getItem('my_astria_id');
                if(savedId) {
                    document.getElementById('tuneIdInput').value = savedId;
                    document.getElementById('idBlock').style.display = 'block';
                    document.getElementById('noIdWarning').style.display = 'none';
                }
            }
        }

        function setSize(w, h, btn) {
            currentW = w;
            currentH = h;
            document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function startTraining() {
            const files = document.getElementById('photos').files;
            const name = document.getElementById('modelName').value;
            const btn = document.getElementById('trainBtn');
            const status = document.getElementById('trainStatus');
            
            if(files.length < 4) return alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 4 —Ñ–æ—Ç–æ!');
            
            btn.disabled = true;
            btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            status.innerText = "–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å–∞–π—Ç, —Ñ–∞–π–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è...";

            const formData = new FormData();
            formData.append('modelName', name);
            for(let i=0; i<files.length; i++) formData.append('photos', files[i]);

            try {
                const res = await fetch('/api/train', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.success) {
                    // –ê–í–¢–û-–°–û–•–†–ê–ù–ï–ù–ò–ï ID
                    localStorage.setItem('my_astria_id', data.tune_id);
                    
                    status.innerHTML = `<span style="color:#4f4">‚úÖ –£—Å–ø–µ—à–Ω–æ! ID: ${data.tune_id}</span><br>–û–±—É—á–µ–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å. –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –≤–æ –≤–∫–ª–∞–¥–∫—É "–†–∏—Å–æ–≤–∞—Ç—å". –í–∞—à ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω.`;
                    btn.innerText = "–û–ë–£–ß–ï–ù–ò–ï –ó–ê–ü–£–©–ï–ù–û";
                } else {
                    let err = data.error;
                    if(data.details) err += " " + JSON.stringify(data.details);
                    alert("–û—à–∏–±–∫–∞: " + err);
                    btn.disabled = false;
                    btn.innerText = "–ó–ê–ü–£–°–¢–ò–¢–¨ –û–ë–£–ß–ï–ù–ò–ï";
                }
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                btn.disabled = false;
            }
        }

        async function generate() {
            const prompt = document.getElementById('promptInput').value;
            const tuneId = document.getElementById('tuneIdInput').value;
            const btn = document.getElementById('genBtn');
            const status = document.getElementById('genStatus');
            const gallery = document.getElementById('gallery');

            if(!tuneId) return alert('–ù–µ—Ç ID –º–æ–¥–µ–ª–∏. –°–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –µ—ë.');
            if(!prompt) return alert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ!');

            btn.disabled = true;
            btn.innerText = "–†–ò–°–£–Æ...";
            status.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è... –ñ–¥–∏—Ç–µ ~30 —Å–µ–∫.";
            gallery.innerHTML = '';

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        prompt, 
                        tune_id: tuneId,
                        w: currentW, 
                        h: currentH
                    })
                });
                const data = await res.json();

                if(data.success) {
                    const img = document.createElement('img');
                    img.src = data.image;
                    img.className = 'result-img';
                    gallery.appendChild(img);
                    status.innerText = "–ì–æ—Ç–æ–≤–æ!";
                } else {
                    status.innerText = "–û—à–∏–±–∫–∞: " + data.error;
                }
            } catch(e) {
                status.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
            } finally {
                btn.disabled = false;
                btn.innerText = "–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨";
            }
        }

        // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        document.getElementById('photos').addEventListener('change', function() {
            if(this.files.length > 0) {
                document.getElementById('fileLabel').innerText = `‚úÖ –í—ã–±—Ä–∞–Ω–æ —Ñ–æ—Ç–æ: ${this.files.length}`;
                document.getElementById('dropArea').classList.add('active');
            }
        });
    </script>
</body>
</html>