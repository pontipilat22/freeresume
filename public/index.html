<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Studio Flux</title>
    <style>
        body { background: #050505; color: #fff; font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 0; }
        
        /* –¢–∞–±—ã */
        .tabs { display: flex; border-bottom: 1px solid #222; position: sticky; top:0; background: #050505; z-index: 99; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; color: #666; font-weight: 600; text-transform: uppercase; font-size: 14px; transition: 0.2s; }
        .tab.active { color: #fff; border-bottom: 2px solid #fff; background: #111; }

        .content { display: none; padding: 20px; max-width: 500px; margin: 0 auto; min-height: 80vh; }
        .content.active { display: block; animation: fadeIn 0.3s; }

        h2 { font-weight: 200; text-align: center; margin-bottom: 25px; letter-spacing: 1px; }

        /* –§–æ—Ä–º—ã */
        input, textarea {
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #fff;
            padding: 14px; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; outline: none;
        }
        input:focus, textarea:focus { border-color: #666; }
        
        button {
            width: 100%; padding: 16px; background: #fff; color: #000;
            border: none; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .upload-area {
            border: 2px dashed #333; padding: 40px 20px; text-align: center; border-radius: 12px;
            margin-bottom: 20px; cursor: pointer; color: #888; transition: 0.2s; background: #111;
        }
        .upload-area:active { background: #222; border-color: #666; }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        .result-box { margin-top: 25px; padding: 20px; background: #111; border-radius: 12px; display: none; border: 1px solid #222; }
        .result-box img { width: 100%; border-radius: 8px; margin-top: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        
        .id-display {
            background: #222; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 20px;
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border: 1px solid #333;
        }
        .copy-btn { width: auto; padding: 8px 15px; font-size: 12px; margin: 0; background: #444; color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('train')">1. –û–±—É—á–µ–Ω–∏–µ</div>
        <div class="tab" onclick="switchTab('gen')">2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
    </div>

    <!-- –í–ö–õ–ê–î–ö–ê 1: –û–ë–£–ß–ï–ù–ò–ï -->
    <div id="train" class="content active">
        <h2>–°–æ–∑–¥–∞—Ç—å –ê–≤–∞—Ç–∞—Ä</h2>
        <p style="color:#666; text-align:center; font-size:13px; margin-bottom:20px;">
            –ù—É–∂–Ω–æ 5-15 —Ñ–æ—Ç–æ –ª–∏—Ü–∞ –∫—Ä—É–ø–Ω—ã–º –ø–ª–∞–Ω–æ–º.<br>–û–±—É—á–µ–Ω–∏–µ –∑–∞–π–º–µ—Ç ~30 –º–∏–Ω—É—Ç.
        </p>

        <input type="text" id="modelName" placeholder="–ò–º—è –º–æ–¥–µ–ª–∏ (English)">
        
        <label class="upload-area">
            <span id="fileLabel">üì∏ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span>
            <input type="file" id="photos" multiple accept="image/*" style="display:none">
        </label>

        <button onclick="startTraining()" id="trainBtn">–ù–ê–ß–ê–¢–¨ –û–ë–£–ß–ï–ù–ò–ï</button>
        
        <div id="trainResult" class="result-box">
            <div style="color: #4f4; margin-bottom:10px;">‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!</div>
            <div style="font-size:14px; color:#aaa;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç ID. –ß–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è".</div>
            
            <div class="id-display">
                <span id="newTuneId">...</span>
                <button class="copy-btn" onclick="copyId()">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –í–ö–õ–ê–î–ö–ê 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø -->
    <div id="gen" class="content">
        <h2>–°–æ–∑–¥–∞—Ç—å –§–æ—Ç–æ</h2>
        
        <input type="number" id="tuneIdInput" placeholder="ID –ú–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)">
        <textarea id="promptInput" rows="4" placeholder="–ü—Ä–æ–º–ø—Ç (–ù–∞–ø—Ä–∏–º–µ—Ä: ohwx man portrait, space suit, cinematic lighting)"></textarea>
        
        <button onclick="generate()" id="genBtn">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>

        <div id="genStatus" style="text-align:center; margin-top:20px; color:#666; font-size:14px;"></div>
        
        <div id="genResult" class="result-box" style="display:block; background:none; border:none; padding:0;">
            <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            if(tabName === 'train') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('train').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('gen').classList.add('active');
            }
        }

        async function startTraining() {
            const files = document.getElementById('photos').files;
            const name = document.getElementById('modelName').value;
            const btn = document.getElementById('trainBtn');
            
            if(files.length < 4) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 4 —Ñ–æ—Ç–æ!');
            
            btn.disabled = true;
            btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (–∂–¥–∏—Ç–µ)...";

            const formData = new FormData();
            formData.append('modelName', name);
            for(let i=0; i<files.length; i++) formData.append('photos', files[i]);

            try {
                const res = await fetch('/api/train', { method: 'POST', body: formData });
                const data = await res.json();
                
                if(data.success) {
                    document.getElementById('trainResult').style.display = 'block';
                    document.getElementById('newTuneId').innerText = data.tune_id;
                    document.getElementById('tuneIdInput').value = data.tune_id; // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                    btn.innerText = "–£–°–ü–ï–®–ù–û";
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    btn.disabled = false;
                    btn.innerText = "–ù–ê–ß–ê–¢–¨ –û–ë–£–ß–ï–ù–ò–ï";
                }
            } catch(e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç');
                btn.disabled = false;
                btn.innerText = "–ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê";
            }
        }

        async function generate() {
            const prompt = document.getElementById('promptInput').value;
            const tuneId = document.getElementById('tuneIdInput').value;
            const btn = document.getElementById('genBtn');
            const status = document.getElementById('genStatus');
            const resDiv = document.getElementById('genResult');

            if(!prompt || !tuneId) return alert('–í–≤–µ–¥–∏—Ç–µ ID –º–æ–¥–µ–ª–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ!');

            btn.disabled = true;
            btn.innerText = "–î–£–ú–ê–Æ...";
            status.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 1 –º–∏–Ω—É—Ç—ã.";
            resDiv.innerHTML = '';

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt, tune_id: tuneId })
                });
                const data = await res.json();

                if(data.success) {
                    const img = document.createElement('img');
                    img.src = data.image;
                    resDiv.appendChild(img);
                    status.innerText = "–ì–æ—Ç–æ–≤–æ!";
                } else {
                    status.innerText = "–û—à–∏–±–∫–∞: " + (data.error || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –º–æ–¥–µ–ª–∏');
                }
            } catch(e) {
                status.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
            } finally {
                btn.disabled = false;
                btn.innerText = "–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨";
            }
        }

        document.getElementById('photos').addEventListener('change', function() {
            if(this.files.length > 0) document.getElementById('fileLabel').innerText = `‚úÖ –í—ã–±—Ä–∞–Ω–æ: ${this.files.length}`;
        });

        function copyId() {
            const id = document.getElementById('newTuneId').innerText;
            navigator.clipboard.writeText(id);
            alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
        }
    </script>
</body>
</html>